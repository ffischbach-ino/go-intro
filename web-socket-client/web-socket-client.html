<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <link rel="stylesheet" href="web-socket-client.css">
  </head>
  <body>
    <main class="container">
        <h2>Chat</h2>
        
        <form id="chat-form">
            <div class="form-group">
                <label for="username">Username</label>
                <input value="Fynn" type="text" id="username" autocomplete="username">
            </div>
            <div class="form-group">
                <label for="message">Message</label>
                <input value="Hallo Welt!" type="text" id="message" autocomplete="off">
            </div>
            <button type="submit" id="submitButton">Senden</button>
        </form>
      
        <ul id="websocket_events"></ul>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatForm = document.getElementById('chat-form');
            const usernameInput = document.getElementById('username');
            const messageInput = document.getElementById('message');
            const messageList = document.getElementById('websocket_events')
            const socket = new WebSocket("ws://127.0.0.1:8080/ws");
            console.log("Attempting Connection...");

            /**
             * FÃ¼gt eine Nachricht zur Liste im HTML hinzu.
             * @param {string} text - Die anzuzeigende Nachricht.
             */
            const appendMessage = (text) => {
                const listItem = document.createElement('li');
                listItem.textContent = text;
                messageList.appendChild(listItem);
            };

            const sendMessage = () => {
                if(event) {
                event.preventDefault();
                }

                const messagePayload = {
                    user: usernameInput.value,
                    value: messageInput.value,
                };
                socket.send(JSON.stringify(messagePayload));
                messageInput.value = ''; 
            };

            chatForm.addEventListener('submit', sendMessage);
            
            messageInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });

            socket.onopen = () => {
                console.log("Successfully Connected");
                appendMessage("Status: Verbindung erfolgreich hergestellt.");
            };

            socket.onclose = (event) => {
                console.log("Socket Closed Connection: ", event);
                appendMessage("Status: Verbindung geschlossen.");
            };

            socket.onerror = (error) => {
                console.error("Socket Error: ", error);
                appendMessage("Fehler: Verbindung fehlgeschlagen.");
            };

            socket.onmessage = (event) => {
                try {
                    const messageData = JSON.parse(event.data);
                    console.log("Received:", messageData);
                    
                    const messageToDisplay = `[${messageData.user}] ${messageData.value}`;
                    appendMessage(messageToDisplay);
                } catch (e) {
                    console.error("Error parsing message data:", e);
                    appendMessage(event.data);
                }
            };
        });
    </script>
  </body>
</html>